#!/bin/sh
set -e
# Main install entrypoint - bootstrap config and install packages for detected OS.

# -----------------------------------------------------------------------------
# Paths
# -----------------------------------------------------------------------------

REPO_DIR=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)
INSTALL_DIR="$REPO_DIR/installers"
DOTFILES_CONFIG_DIR="$REPO_DIR/config"
ZDOTDIR_DEFAULT="${ZDOTDIR:-$HOME}"
DOTFILES_ZIM_HOME="${DOTFILES_ZIM_HOME:-$ZDOTDIR_DEFAULT/.zim}"
DOTFILES_ZIM_CONFIG="${DOTFILES_ZIM_CONFIG:-$ZDOTDIR_DEFAULT/.zimrc}"

. "$INSTALL_DIR/lib.sh"

# -----------------------------------------------------------------------------
# Config
# -----------------------------------------------------------------------------

MISE_INSTALL_ENABLED="${DOTFILES_MISE_INSTALL:-1}"
ZIMFW_INSTALL_ENABLED="${DOTFILES_ZIMFW_INSTALL:-1}"
ZIMFW_BUILD_ENABLED="${DOTFILES_ZIMFW_BUILD:-1}"
ZIMFW_DOWNLOAD_ENABLED="${DOTFILES_ZIMFW_DOWNLOAD:-1}"
POST_INSTALL_ENABLED="${DOTFILES_POST_INSTALL:-1}"
STATE_DIR_NAME="dotfiles"

# -----------------------------------------------------------------------------
# OS detection
# -----------------------------------------------------------------------------

log_os() {
  log "detected OS: $1"
}

detect_os() {
  case "$(uname -s)" in
    Darwin)
      echo "macos"
      ;;
    Linux)
      echo "linux"
      ;;
    MINGW* | MSYS* | CYGWIN*)
      echo "windows"
      ;;
    *)
      log "Unknown OS: $(uname -s)"
      exit 1
      ;;
  esac
}

# -----------------------------------------------------------------------------
# Bootstrap and install
# -----------------------------------------------------------------------------

run_bootstrap() {
  log "running bootstrap..."
  sh "$INSTALL_DIR/link.sh"
}

run_package_installation() {
  os="$1"

  case "$os" in
    linux)
      if [ -x "$INSTALL_DIR/install-arch.sh" ]; then
        log "installing Arch packages..."
        "$INSTALL_DIR/install-arch.sh"
      else
        log "error: installers/install-arch.sh not found or not executable"
        exit 1
      fi
      ;;
    macos)
      if [ -x "$INSTALL_DIR/install-macos.sh" ]; then
        log "installing macOS packages..."
        "$INSTALL_DIR/install-macos.sh"
      else
        log "error: installers/install-macos.sh not found or not executable"
        exit 1
      fi
      ;;
    windows)
      log "Windows detected: please run 'pwsh -ExecutionPolicy Bypass -File installers/install-windows.ps1'"
      log "or: 'powershell.exe -ExecutionPolicy Bypass -File installers/install-windows.ps1'"
      exit 0
      ;;
    *)
      log "error: unsupported OS: $os"
      exit 1
      ;;
  esac
}

# -----------------------------------------------------------------------------
# Tool setup
# -----------------------------------------------------------------------------

get_user_home() {
  if [ -n "${SUDO_USER:-}" ]; then
    # Validate SUDO_USER is a valid username (alphanumeric, underscores, hyphens)
    case "$SUDO_USER" in
      *[!a-zA-Z0-9_-]*)
        printf '%s\n' "$HOME"
        return 0
        ;;
    esac

    _user_home=""
    if command -v getent >/dev/null 2>&1; then
      _user_home=$(getent passwd "$SUDO_USER" 2>/dev/null | cut -d: -f6)
    fi
    if [ -z "$_user_home" ]; then
      # Fallback: check user's home directory directly
      if [ -d "/home/$SUDO_USER" ]; then
        _user_home="/home/$SUDO_USER"
      elif [ -n "${HOME:-}" ]; then
        _user_home="$HOME"
      fi
    fi
    [ -n "$_user_home" ] || _user_home="$HOME"
  else
    _user_home="$HOME"
  fi
  printf '%s\n' "$_user_home"
}

get_state_home() {
  _user_home=$(get_user_home)
  if [ -n "${SUDO_USER:-}" ]; then
    printf '%s\n' "$_user_home/.local/state"
  else
    printf '%s\n' "${XDG_STATE_HOME:-$_user_home/.local/state}"
  fi
}

run_mise_install() {
  if [ "$MISE_INSTALL_ENABLED" != "1" ]; then
    log "mise install disabled (DOTFILES_MISE_INSTALL=0)"
    return 0
  fi

  if has_command mise; then
    _state_home=$(get_state_home)
    _marker_dir="$_state_home/$STATE_DIR_NAME"
    _marker_file="$_marker_dir/mise-installed"

    if [ ! -f "$_marker_file" ]; then
      log "installing mise tools from config..."
      run_as_user sh -c 'mkdir -p "$1" && mise install && touch "$2"' _ "$_marker_dir" "$_marker_file"
    else
      log "mise tools already installed from config, skipping"
    fi
  else
    log "mise not found, skipping tool install"
  fi
}

run_zimfw_build() {
  if [ "$ZIMFW_BUILD_ENABLED" != "1" ]; then
    log "zimfw build disabled (DOTFILES_ZIMFW_BUILD=0)"
    return 0
  fi

  if ! has_command zsh; then
    log "zsh not found, skipping zimfw build"
    return 0
  fi

  _zimfw_zsh=""
  for _candidate in \
    "$DOTFILES_ZIM_HOME/zimfw.zsh" \
    "$HOME/.zim/zimfw.zsh" \
    "/usr/share/zimfw/zimfw.zsh" \
    "/opt/homebrew/opt/zimfw/share/zimfw.zsh" \
    "/usr/local/opt/zimfw/share/zimfw.zsh"; do
    if [ -r "$_candidate" ]; then
      _zimfw_zsh="$_candidate"
      break
    fi
  done

  if [ -z "$_zimfw_zsh" ] && [ "$ZIMFW_DOWNLOAD_ENABLED" = "1" ]; then
    _zimfw_url="https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh"
    ensure_dir "$DOTFILES_ZIM_HOME"
    if has_command curl; then
      log "downloading zimfw..."
      run_as_user env ZIM_HOME="$DOTFILES_ZIM_HOME" ZIM_CONFIG_FILE="$DOTFILES_ZIM_CONFIG" \
        sh -c 'curl -fsSL "$1" -o "$2"' _ "$_zimfw_url" "$DOTFILES_ZIM_HOME/zimfw.zsh"
    elif has_command wget; then
      log "downloading zimfw..."
      run_as_user env ZIM_HOME="$DOTFILES_ZIM_HOME" ZIM_CONFIG_FILE="$DOTFILES_ZIM_CONFIG" \
        sh -c 'wget -qO "$2" "$1"' _ "$_zimfw_url" "$DOTFILES_ZIM_HOME/zimfw.zsh"
    fi
    if [ -r "$DOTFILES_ZIM_HOME/zimfw.zsh" ]; then
      _zimfw_zsh="$DOTFILES_ZIM_HOME/zimfw.zsh"
    fi
  fi

  if [ -z "$_zimfw_zsh" ]; then
    log "zimfw not found, skipping zimfw build"
    return 0
  fi

  _modules_present=0
  if [ -d "$DOTFILES_ZIM_HOME/modules" ]; then
    if find "$DOTFILES_ZIM_HOME/modules" -type f -print -quit 2>/dev/null | grep -q .; then
      _modules_present=1
    fi
  fi

  if [ "$ZIMFW_INSTALL_ENABLED" = "1" ] && [ "$_modules_present" -eq 0 ]; then
    log "zimfw modules missing, running zimfw init..."
    run_as_user env ZIM_HOME="$DOTFILES_ZIM_HOME" ZIM_CONFIG_FILE="$DOTFILES_ZIM_CONFIG" \
      zsh "$_zimfw_zsh" init
    return 0
  fi

  log "building zimfw init..."
  run_as_user env ZIM_HOME="$DOTFILES_ZIM_HOME" ZIM_CONFIG_FILE="$DOTFILES_ZIM_CONFIG" \
    zsh "$_zimfw_zsh" build
}

run_tool_setup() {
  run_mise_install
  run_zimfw_build
}

run_post_install() {
  if [ "$POST_INSTALL_ENABLED" != "1" ]; then
    log "post-install disabled (DOTFILES_POST_INSTALL=0)"
    return 0
  fi

  if [ -x "$INSTALL_DIR/post-install.sh" ]; then
    log "running post-install setup..."
    "$INSTALL_DIR/post-install.sh"
  else
    log "post-install script not found, skipping"
  fi
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------

main() {
  _os=$(detect_os)
  log_os "$_os"

  run_bootstrap
  run_package_installation "$_os"
  run_tool_setup
  run_post_install

  log "installation complete!"
  log "reload your shell: source ~/.zshrc or source ~/.bashrc"
}

main "$@"
