#!/bin/sh
set -euo pipefail
# Main install entrypoint - bootstrap config and install packages for detected OS.

# -----------------------------------------------------------------------------
# Paths
# -----------------------------------------------------------------------------

REPO_DIR=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)
LIB_INSTALL_DIR="$REPO_DIR/lib/install"
OS_INSTALL_DIR="$REPO_DIR/os/install"
DOTFILES_CONFIG_DIR="$REPO_DIR/config"
ZDOTDIR_DEFAULT="${ZDOTDIR:-$HOME}"
DOTFILES_ZIM_HOME="${DOTFILES_ZIM_HOME:-$ZDOTDIR_DEFAULT/.zim}"
DOTFILES_ZIM_CONFIG="${DOTFILES_ZIM_CONFIG:-$ZDOTDIR_DEFAULT/.zimrc}"

. "$LIB_INSTALL_DIR/lib.sh"

# -----------------------------------------------------------------------------
# Platform/ Distro Detection
# -----------------------------------------------------------------------------

# Source lib/utils.sh if it exists, otherwise use inline detection
if [ -f "$LIB_INSTALL_DIR/lib/utils.sh" ]; then
  . "$LIB_INSTALL_DIR/lib/utils.sh"
fi

# Inline fallback detection functions (used if lib/utils.sh doesn't exist)
# These follow the same naming convention as lib/utils.sh for compatibility

_detect_wsl() {
  # Check for WSL via multiple methods
  if [ -f /proc/sys/fs/binfmt_misc/WSLInterop ] 2>/dev/null; then
    return 0
  fi
  if [ -f /proc/version ] && grep -qi microsoft /proc/version 2>/dev/null; then
    return 0
  fi
  if [ -n "${WSL_DISTRO_NAME:-}" ]; then
    return 0
  fi
  return 1
}

_detect_wsl_distro() {
  # Try to get the WSL distro name
  if [ -n "${WSL_DISTRO_NAME:-}" ]; then
    printf '%s\n' "$WSL_DISTRO_NAME"
    return 0
  fi
  if [ -f /etc/os-release ]; then
    _id=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')
    printf '%s\n' "$_id"
    return 0
  fi
  printf '%s\n' "Unknown"
}

_detect_macos_arch() {
  _arch=$(uname -m)
  case "$_arch" in
    arm64) printf '%s\n' "arm64" ;;
    x86_64) printf '%s\n' "x86_64" ;;
    *) printf '%s\n' "$_arch" ;;
  esac
}

_detect_linux_distro() {
  if [ -f /etc/os-release ]; then
    _id=$(grep '^ID=' /etc/os-release | cut -d= -f2 | tr -d '"')
    _name=$(grep '^NAME=' /etc/os-release | cut -d= -f2 | tr -d '"')
    case "$_id" in
      arch|manjaro|endeavouros) printf '%s\n' "Arch Linux" ;;
      ubuntu) printf '%s\n' "Ubuntu" ;;
      debian) printf '%s\n' "Debian" ;;
      fedora) printf '%s\n' "Fedora" ;;
      *) printf '%s\n' "$_name" ;;
    esac
  else
    printf '%s\n' "Linux"
  fi
}

# Public detection API (works with or without lib/utils.sh)
detect_platform() {
  _kernel=$(uname -s)
  case "$_kernel" in
    Darwin)
      _arch=$(_detect_macos_arch)
      printf '%s\n' "macOS ($_arch)"
      ;;
    Linux)
      if _detect_wsl; then
        _wsl_distro=$(_detect_wsl_distro)
        # Capitalize first letter of distro
        _wsl_distro_display=$(printf '%s' "$_wsl_distro" | sed 's/.*/\u&/' 2>/dev/null || printf '%s' "$_wsl_distro")
        printf '%s\n' "WSL ($_wsl_distro_display)"
      else
        _distro=$(_detect_linux_distro)
        printf '%s\n' "$_distro"
      fi
      ;;
    MINGW* | MSYS* | CYGWIN*)
      printf '%s\n' "Windows"
      ;;
    *)
      printf '%s\n' "Unknown ($_kernel)"
      ;;
  esac
}

show_platform_info() {
  _platform=$(detect_platform)
  log ""
  log "=== Dotfiles Install ==="
  log "Platform: $_platform"
  log ""
}

show_unsupported_distro_message() {
  _distro="${1:-}"
  log ""
  log "WARNING: $_distro is not fully supported by the automatic installer."
  log ""
  log "The following components will still be set up:"
  log "  - Configuration file symlinks (via link.sh)"
  log "  - mise tool installation (if mise is available)"
  log "  - zimfw module setup (if zsh is available)"
  log ""
  log "For package installation, please install equivalents of the Arch packages"
  log "listed in lib/install/packages/arch/ manually for your distribution."
  log ""
  log "Continuing with available setup..."
  log ""
}

is_distro_supported() {
  _platform="${1:-}"
  case "$_platform" in
    "macOS"*|"WSL"*|"Arch Linux"*)
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

# -----------------------------------------------------------------------------
# Config
# -----------------------------------------------------------------------------

MISE_INSTALL_ENABLED="${DOTFILES_MISE_INSTALL:-1}"
ZIMFW_INSTALL_ENABLED="${DOTFILES_ZIMFW_INSTALL:-1}"
ZIMFW_BUILD_ENABLED="${DOTFILES_ZIMFW_BUILD:-1}"
ZIMFW_DOWNLOAD_ENABLED="${DOTFILES_ZIMFW_DOWNLOAD:-1}"
POST_INSTALL_ENABLED="${DOTFILES_POST_INSTALL:-1}"
STATE_DIR_NAME="dotfiles"

# -----------------------------------------------------------------------------
# OS detection (legacy compatibility)
# -----------------------------------------------------------------------------

log_os() {
  log "detected OS: $1"
}

detect_os() {
  case "$(uname -s)" in
    Darwin)
      echo "macos"
      ;;
    Linux)
      echo "linux"
      ;;
    MINGW* | MSYS* | CYGWIN*)
      echo "windows"
      ;;
    *)
      log "Unknown OS: $(uname -s)"
      exit 1
      ;;
  esac
}

# -----------------------------------------------------------------------------
# Bootstrap and install
# -----------------------------------------------------------------------------

run_bootstrap() {
  log "running bootstrap..."
  sh "$LIB_INSTALL_DIR/link.sh"
}

run_package_installation() {
  os="$1"

  case "$os" in
    linux)
      if [ -x "$OS_INSTALL_DIR/arch.sh" ]; then
        log "installing Arch packages..."
        "$OS_INSTALL_DIR/arch.sh"
      else
        log "error: os/install/arch.sh not found or not executable"
        exit 1
      fi
      ;;
    macos)
      if [ -x "$OS_INSTALL_DIR/macos.sh" ]; then
        log "installing macOS packages..."
        "$OS_INSTALL_DIR/macos.sh"
      else
        log "error: os/install/macos.sh not found or not executable"
        exit 1
      fi
      ;;
    windows)
      log "Windows detected: please run 'pwsh -ExecutionPolicy Bypass -File lib/install/install-windows.ps1'"
      log "or: 'powershell.exe -ExecutionPolicy Bypass -File lib/install/install-windows.ps1'"
      exit 0
      ;;
    *)
      log "error: unsupported OS: $os"
      exit 1
      ;;
  esac
}

# -----------------------------------------------------------------------------
# Tool setup
# -----------------------------------------------------------------------------

get_user_home() {
  if [ -n "${SUDO_USER:-}" ]; then
    # Validate SUDO_USER is a valid username (alphanumeric, underscores, hyphens)
    case "$SUDO_USER" in
      *[!a-zA-Z0-9_-]*)
        printf '%s\n' "$HOME"
        return 0
        ;;
    esac

    _user_home=""
    if command -v getent >/dev/null 2>&1; then
      _user_home=$(getent passwd "$SUDO_USER" 2>/dev/null | cut -d: -f6)
    fi
    if [ -z "$_user_home" ]; then
      # Fallback: check user's home directory directly
      if [ -d "/home/$SUDO_USER" ]; then
        _user_home="/home/$SUDO_USER"
      elif [ -n "${HOME:-}" ]; then
        _user_home="$HOME"
      fi
    fi
    [ -n "$_user_home" ] || _user_home="$HOME"
  else
    _user_home="$HOME"
  fi
  printf '%s\n' "$_user_home"
}

get_state_home() {
  _user_home=$(get_user_home)
  if [ -n "${SUDO_USER:-}" ]; then
    printf '%s\n' "$_user_home/.local/state"
  else
    printf '%s\n' "${XDG_STATE_HOME:-$_user_home/.local/state}"
  fi
}

run_mise_install() {
  if [ "$MISE_INSTALL_ENABLED" != "1" ]; then
    log "mise install disabled (DOTFILES_MISE_INSTALL=0)"
    return 0
  fi

  if __dot_has mise; then
    _state_home=$(get_state_home)
    _marker_dir="$_state_home/$STATE_DIR_NAME"
    _marker_file="$_marker_dir/mise-installed"

    if [ ! -f "$_marker_file" ]; then
      log "installing mise tools from config..."
      run_as_user sh -c 'mkdir -p "$1" && mise install && touch "$2"' _ "$_marker_dir" "$_marker_file"
    else
      log "mise tools already installed from config, skipping"
    fi
  else
    log "mise not found, skipping tool install"
  fi
}

run_zimfw_build() {
  if [ "$ZIMFW_BUILD_ENABLED" != "1" ]; then
    log "zimfw build disabled (DOTFILES_ZIMFW_BUILD=0)"
    return 0
  fi

  if ! __dot_has zsh; then
    log "zsh not found, skipping zimfw build"
    return 0
  fi

  _zimfw_zsh=""
  for _candidate in \
    "$DOTFILES_ZIM_HOME/zimfw.zsh" \
    "$HOME/.zim/zimfw.zsh" \
    "/usr/share/zimfw/zimfw.zsh" \
    "/opt/homebrew/opt/zimfw/share/zimfw.zsh" \
    "/usr/local/opt/zimfw/share/zimfw.zsh"; do
    if [ -r "$_candidate" ]; then
      _zimfw_zsh="$_candidate"
      break
    fi
  done

  if [ -z "$_zimfw_zsh" ] && [ "$ZIMFW_DOWNLOAD_ENABLED" = "1" ]; then
    _zimfw_url="https://github.com/zimfw/zimfw/releases/latest/download/zimfw.zsh"
    ensure_dir "$DOTFILES_ZIM_HOME"
    if __dot_has curl; then
      log "downloading zimfw..."
      run_as_user env ZIM_HOME="$DOTFILES_ZIM_HOME" ZIM_CONFIG_FILE="$DOTFILES_ZIM_CONFIG" \
        sh -c 'curl -fsSL "$1" -o "$2"' _ "$_zimfw_url" "$DOTFILES_ZIM_HOME/zimfw.zsh"
    elif __dot_has wget; then
      log "downloading zimfw..."
      run_as_user env ZIM_HOME="$DOTFILES_ZIM_HOME" ZIM_CONFIG_FILE="$DOTFILES_ZIM_CONFIG" \
        sh -c 'wget -qO "$2" "$1"' _ "$_zimfw_url" "$DOTFILES_ZIM_HOME/zimfw.zsh"
    fi
    if [ -r "$DOTFILES_ZIM_HOME/zimfw.zsh" ]; then
      _zimfw_zsh="$DOTFILES_ZIM_HOME/zimfw.zsh"
    fi
  fi

  if [ -z "$_zimfw_zsh" ]; then
    log "zimfw not found, skipping zimfw build"
    return 0
  fi

  _modules_present=0
  if [ -d "$DOTFILES_ZIM_HOME/modules" ]; then
    if find "$DOTFILES_ZIM_HOME/modules" -type f -print -quit 2>/dev/null | grep -q .; then
      _modules_present=1
    fi
  fi

  if [ "$ZIMFW_INSTALL_ENABLED" = "1" ] && [ "$_modules_present" -eq 0 ]; then
    log "zimfw modules missing, running zimfw init..."
    run_as_user env ZIM_HOME="$DOTFILES_ZIM_HOME" ZIM_CONFIG_FILE="$DOTFILES_ZIM_CONFIG" \
      zsh "$_zimfw_zsh" init
    return 0
  fi

  log "building zimfw init..."
  run_as_user env ZIM_HOME="$DOTFILES_ZIM_HOME" ZIM_CONFIG_FILE="$DOTFILES_ZIM_CONFIG" \
    zsh "$_zimfw_zsh" build
}

run_tool_setup() {
  run_mise_install
  run_zimfw_build
}

run_post_install() {
  if [ "$POST_INSTALL_ENABLED" != "1" ]; then
    log "post-install disabled (DOTFILES_POST_INSTALL=0)"
    return 0
  fi

  if [ -x "$LIB_INSTALL_DIR/post-install.sh" ]; then
    log "running post-install setup..."
    "$LIB_INSTALL_DIR/post-install.sh"
  else
    log "post-install script not found, skipping"
  fi
}

# -----------------------------------------------------------------------------
# Main
# -----------------------------------------------------------------------------

main() {
  # Show platform info at start
  show_platform_info

  _os=$(detect_os)
  _platform=$(detect_platform)
  log_os "$_os"

  # Check if distro is fully supported for package installation
  if ! is_distro_supported "$_platform"; then
    show_unsupported_distro_message "$_platform"
  fi

  run_bootstrap
  run_package_installation "$_os"
  run_tool_setup
  run_post_install

  log "installation complete!"
  log "reload your shell: source ~/.zshrc or source ~/.bashrc"
}

main "$@"
